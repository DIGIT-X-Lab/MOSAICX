# ==============================================================================
# MOSAICX Docker Image (Slim)
# Without pre-downloaded models - models are pulled on first run
# ==============================================================================
# 
# This is a lighter version of the MOSAICX Docker image.
# Models are downloaded on first run instead of being baked into the image.
#
# Usage:
#   docker build -f Dockerfile.slim -t mosaicx:slim .
#   docker run -it --gpus all -v /path/to/data:/data mosaicx:slim extract /data/doc.pdf --schema /data/schema.py
#
# ==============================================================================

FROM nvidia/cuda:12.4.1-runtime-ubuntu22.04

LABEL maintainer="DIGIT-X Lab <lalith.shiyam@med.uni-muenchen.de>"
LABEL org.opencontainers.image.title="MOSAICX"
LABEL org.opencontainers.image.description="Medical cOmputational Suite for Advanced Intelligent eXtraction (Slim)"
LABEL org.opencontainers.image.version="1.4.2"
LABEL org.opencontainers.image.source="https://github.com/DIGIT-X-Lab/MOSAICX"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Ollama configuration
ENV OLLAMA_HOST=0.0.0.0:11434
ENV OLLAMA_MODELS=/root/.ollama/models

# MOSAICX configuration
ENV MOSAICX_LOG_DIR=/root/.mosaicx/logs

# ==============================================================================
# System Dependencies
# ==============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 \
    python3.11-venv \
    python3-pip \
    curl \
    wget \
    git \
    ca-certificates \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    zstd \
    poppler-utils \
    tesseract-ocr \
    tesseract-ocr-deu \
    tesseract-ocr-eng \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Set Python 3.11 as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.11 1 \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

# ==============================================================================
# Install Ollama
# ==============================================================================
RUN curl -fsSL https://ollama.com/install.sh | sh

# ==============================================================================
# Install MOSAICX
# ==============================================================================
WORKDIR /app

# Copy project files
COPY pyproject.toml README.md LICENSE ./
COPY mosaicx/ ./mosaicx/

# Install MOSAICX
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir .

# ==============================================================================
# Entrypoint Script
# ==============================================================================
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ==============================================================================
# Runtime Configuration
# ==============================================================================
WORKDIR /data
VOLUME ["/data", "/root/.mosaicx", "/root/.ollama"]

EXPOSE 11434

ENTRYPOINT ["/entrypoint.sh"]
CMD ["--help"]
